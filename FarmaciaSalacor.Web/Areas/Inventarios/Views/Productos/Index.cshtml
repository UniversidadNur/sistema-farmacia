@model List<FarmaciaSalacor.Web.Models.Producto>
@{
    ViewData["Title"] = "Productos";

    static int? DiasParaVencimiento(DateOnly? vencimiento)
    {
        if (!vencimiento.HasValue) return null;
        var d = vencimiento.Value.ToDateTime(TimeOnly.MinValue).Date;
        return (d - DateTime.Today).Days;
    }
}

<div class="erp-page-header">
    <div class="erp-page-title">Inventarios &raquo; Productos</div>
    <div class="erp-page-subtitle">Catálogo de productos</div>
</div>

<div class="erp-panel">
    <div class="erp-toolbar">
        <div class="d-flex flex-wrap align-items-center gap-2">
            <a class="btn btn-success btn-sm" asp-action="Create">
                <i class="fa-solid fa-plus"></i> Nuevo
            </a>
            <form id="formImport" asp-area="Inventarios" asp-controller="Productos" asp-action="Import" method="post" enctype="multipart/form-data" style="display:inline-block;">
                @Html.AntiForgeryToken()
                <input id="fileImport" name="file" type="file" accept=".txt" style="display:none" />
                <button id="btnImport" type="button" class="btn btn-outline-primary btn-sm" title="Importar productos desde .txt">
                    <i class="fa-solid fa-file-import"></i> Importar productos (.txt)
                </button>
            </form>
            <a class="btn btn-outline-success btn-sm" asp-area="Inventarios" asp-controller="Productos" asp-action="Export" title="Exportar lista de productos">
                <i class="fa-solid fa-file-export"></i> Exportar lista de productos
            </a>
            <a class="btn btn-outline-secondary btn-sm" asp-area="Inventarios" asp-controller="Marcas" asp-action="Index" title="Administrar laboratorios">
                <i class="fa-solid fa-industry"></i> Laboratorios
            </a>
            <a id="btnEditar" class="btn btn-primary btn-sm disabled" href="#" aria-disabled="true">
                <i class="fa-solid fa-pen"></i> Editar
            </a>
            <a id="btnEliminar" class="btn btn-danger btn-sm disabled" href="#" aria-disabled="true">
                <i class="fa-solid fa-trash"></i> Eliminar
            </a>
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" type="button"
                    data-bs-toggle="collapse" data-bs-target="#invFilterPanel"
                    aria-expanded="false" aria-controls="invFilterPanel" title="Buscar y filtrar">
                <i class="fa-solid fa-filter"></i> Filtros
            </button>

            <div class="text-muted small align-self-center ms-2">
                Total: <strong id="lblInvTotal">@Model.Count</strong>
            </div>
        </div>
    </div>

    @if (TempData["ImportMessage"] != null)
    {
        <div class="p-2">
            <div class="alert alert-info" role="alert">@TempData["ImportMessage"]</div>
        </div>
    }

    <div class="collapse" id="invFilterPanel">
        <div class="p-2 border-top">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="input-group input-group-sm" style="max-width:260px;">
                    <input id="invSearch" class="form-control" placeholder="Buscar medicamento" autocomplete="off" />
                    <button id="btnInvSearch" class="btn btn-outline-secondary" type="button" title="Buscar">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

                <div class="input-group input-group-sm" style="max-width:240px;">
                    <input id="invBarcode" class="form-control" placeholder="Código de barras..." autocomplete="off" />
                    <button id="btnInvBarcode" class="btn btn-outline-secondary" type="button" title="Buscar por código">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

                <select id="invQuick" class="form-select form-select-sm" style="max-width:190px;" title="Filtros rápidos">
                    <option value="all">(Todos)</option>
                    <option value="inStock">Con existencia</option>
                    <option value="outOfStock">Sin existencia</option>
                    <option value="expiring30">Vence en 30 días</option>
                    <option value="expired">Vencidos</option>
                </select>

                <select id="invAccion" class="form-select form-select-sm" style="max-width:210px;" title="Acción terapéutica">
                    <option value="">Acción terapéutica</option>
                </select>

                <select id="invLab" class="form-select form-select-sm" style="max-width:190px;" title="Laboratorio">
                    <option value="">Laboratorio</option>
                </select>

                <button id="btnInvClear" class="btn btn-outline-secondary btn-sm" type="button" title="Limpiar filtros">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="erp-panel-body p-0">
        <div class="table-responsive">
        <table class="table table-sm table-striped table-hover mb-0 erp-table" id="tblProductos">
            <thead>
                <tr>
                    <th style="width:36px;"></th>
                    <th style="width:110px;">Cod</th>
                    <th style="min-width:220px;">Nombre Comercial</th>
                    <th style="min-width:220px;">Nombre Genérico</th>
                    <th style="min-width:170px;">Forma Farmacéutica</th>
                    <th style="min-width:140px;">Concentración</th>
                    <th style="min-width:180px;">Acción Terapéutica</th>
                    <th style="min-width:160px;">Presentación</th>
                    <th style="min-width:160px;">Laboratorio</th>
                    <th style="width:120px;" class="text-end">Precio Venta</th>
                    <th style="width:110px;" class="text-end">Existencia</th>
                    <th style="width:120px;">Vencimiento</th>
                    <th style="width:80px;" class="text-end">Días</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Count == 0)
                {
                    <tr>
                        <td colspan="13" class="text-muted small p-2">No hay productos registrados.</td>
                    </tr>
                }
                else
                {
                    foreach (var p in Model)
                    {
                        var dias = DiasParaVencimiento(p.Vencimiento);
                        <tr class="erp-row-select" data-id="@p.Id">
                            <td class="text-center">
                                <input class="form-check-input" type="radio" name="selProducto" value="@p.Id" />
                            </td>
                            <td class="col-codigo">@p.Codigo</td>
                            <td class="col-nombre">@p.Nombre</td>
                            <td class="col-generico">@(string.IsNullOrWhiteSpace(p.NombreGenerico) ? "-" : p.NombreGenerico)</td>
                            <td class="col-forma">@(string.IsNullOrWhiteSpace(p.FormaFarmaceutica) ? "-" : p.FormaFarmaceutica)</td>
                            <td class="col-conc">@(string.IsNullOrWhiteSpace(p.Concentracion) ? "-" : p.Concentracion)</td>
                            <td class="col-accion">@(p.Categoria?.Nombre ?? "-")</td>
                            <td class="col-pres">@(string.IsNullOrWhiteSpace(p.Presentacion) ? "-" : p.Presentacion)</td>
                            <td class="col-lab">@(p.Marca?.Nombre ?? "-")</td>
                            <td class="text-end col-precio">@p.Precio.ToString("N2")</td>
                            <td class="text-end col-stock">@p.Stock.ToString("N2")</td>
                            <td class="col-venc">@(p.Vencimiento?.ToString("yyyy-MM-dd") ?? "-")</td>
                            <td class="text-end col-dias">@(dias.HasValue ? dias.Value.ToString("N0") : "-")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const btnEditar = document.getElementById('btnEditar');
            const btnEliminar = document.getElementById('btnEliminar');
            const tbl = document.getElementById('tblProductos');
            const invSearch = document.getElementById('invSearch');
            const invBarcode = document.getElementById('invBarcode');
            const btnInvSearch = document.getElementById('btnInvSearch');
            const btnInvBarcode = document.getElementById('btnInvBarcode');
            const invQuick = document.getElementById('invQuick');
            const invAccion = document.getElementById('invAccion');
            const invLab = document.getElementById('invLab');
            const btnInvClear = document.getElementById('btnInvClear');
            const lblInvTotal = document.getElementById('lblInvTotal');
            const btnImport = document.getElementById('btnImport');
            const fileImport = document.getElementById('fileImport');

            function setSelected(id) {
                if (!id) {
                    btnEditar.classList.add('disabled');
                    btnEliminar.classList.add('disabled');
                    btnEditar.setAttribute('href', '#');
                    btnEliminar.setAttribute('href', '#');
                    return;
                }

                btnEditar.classList.remove('disabled');
                btnEliminar.classList.remove('disabled');
                btnEditar.setAttribute('href', '@Url.Action("Edit")/' + id);
                btnEliminar.setAttribute('href', '@Url.Action("Delete")/' + id);
            }

            document.querySelectorAll('input[name="selProducto"]').forEach(r => {
                r.addEventListener('change', function () {
                    setSelected(this.value);
                });
            });

            document.querySelectorAll('tr.erp-row-select').forEach(tr => {
                tr.addEventListener('click', function () {
                    const id = this.getAttribute('data-id');
                    const radio = this.querySelector('input[name="selProducto"]');
                    if (radio) {
                        radio.checked = true;
                        setSelected(id);
                    }
                });
            });

            function norm(s) {
                return ('' + (s ?? '')).trim().toLowerCase();
            }

            function toNum(s) {
                const v = ('' + (s ?? '')).replace(',', '.').trim();
                const n = parseFloat(v);
                return isNaN(n) ? 0 : n;
            }

            function fillSelectDistinct(selectEl, values, placeholder) {
                if (!selectEl) return;
                const current = selectEl.value || '';
                const uniq = Array.from(new Set(values.filter(v => v && v !== '-'))).sort((a, b) => a.localeCompare(b));
                const opts = [
                    `<option value="">${placeholder}</option>`,
                    ...uniq.map(v => `<option value="${v.replaceAll('"', '&quot;')}">${v}</option>`)
                ].join('');
                selectEl.innerHTML = opts;
                selectEl.value = current;
            }

            function initFilterOptions() {
                if (!tbl) return;
                const acciones = [];
                const labs = [];
                tbl.querySelectorAll('tbody tr.erp-row-select').forEach(tr => {
                    const a = (tr.querySelector('.col-accion')?.textContent || '').trim();
                    const l = (tr.querySelector('.col-lab')?.textContent || '').trim();
                    if (a) acciones.push(a);
                    if (l) labs.push(l);
                });
                fillSelectDistinct(invAccion, acciones, 'Acción terapéutica');
                fillSelectDistinct(invLab, labs, 'Laboratorio');
            }

            function applyFilter() {
                if (!tbl) return;
                const q = norm(invSearch ? invSearch.value : '');
                const qb = norm(invBarcode ? invBarcode.value : '');

                const quick = (invQuick && invQuick.value) ? invQuick.value : 'all';
                const accionSel = (invAccion && invAccion.value) ? norm(invAccion.value) : '';
                const labSel = (invLab && invLab.value) ? norm(invLab.value) : '';

                let visible = 0;
                tbl.querySelectorAll('tbody tr.erp-row-select').forEach(tr => {
                    const rowText = norm(tr.textContent);
                    const codigoCell = tr.querySelector('.col-codigo');
                    const codigo = norm(codigoCell ? codigoCell.textContent : '');

                    const stockCell = tr.querySelector('.col-stock');
                    const stock = toNum(stockCell ? stockCell.textContent : '0');
                    const diasCell = tr.querySelector('.col-dias');
                    const diasTxt = (diasCell ? diasCell.textContent : '').trim();
                    const dias = diasTxt && diasTxt !== '-' ? parseInt(diasTxt, 10) : null;

                    const accionTxt = norm(tr.querySelector('.col-accion')?.textContent || '');
                    const labTxt = norm(tr.querySelector('.col-lab')?.textContent || '');

                    const okGeneral = !q || rowText.includes(q);
                    const okBarcode = !qb || codigo.includes(qb);

                    let okQuick = true;
                    if (quick === 'inStock') okQuick = stock > 0;
                    else if (quick === 'outOfStock') okQuick = stock <= 0;
                    else if (quick === 'expiring30') okQuick = (dias !== null) && dias >= 0 && dias <= 30;
                    else if (quick === 'expired') okQuick = (dias !== null) && dias < 0;

                    const okAccion = !accionSel || accionTxt === accionSel;
                    const okLab = !labSel || labTxt === labSel;

                    const show = okGeneral && okBarcode && okQuick && okAccion && okLab;

                    tr.style.display = show ? '' : 'none';
                    if (show) visible++;
                });

                if (lblInvTotal) lblInvTotal.textContent = '' + visible;
            }

            if (invSearch) invSearch.addEventListener('input', applyFilter);
            if (invBarcode) invBarcode.addEventListener('input', applyFilter);
            if (btnInvSearch && invSearch) btnInvSearch.addEventListener('click', () => { invSearch.focus(); applyFilter(); });
            if (btnInvBarcode && invBarcode) btnInvBarcode.addEventListener('click', () => { invBarcode.focus(); applyFilter(); });
            if (invQuick) invQuick.addEventListener('change', applyFilter);
            if (invAccion) invAccion.addEventListener('change', applyFilter);
            if (invLab) invLab.addEventListener('change', applyFilter);

            if (btnInvClear) {
                btnInvClear.addEventListener('click', () => {
                    if (invSearch) invSearch.value = '';
                    if (invBarcode) invBarcode.value = '';
                    if (invQuick) invQuick.value = 'all';
                    if (invAccion) invAccion.value = '';
                    if (invLab) invLab.value = '';
                    applyFilter();
                });
            }

            if (btnImport && fileImport) {
                btnImport.addEventListener('click', () => fileImport.click());
                fileImport.addEventListener('change', function () {
                    if (this.files && this.files.length > 0) {
                        if (confirm('Importar productos desde el archivo seleccionado?')) {
                            // submit the enclosing form
                            const frm = document.getElementById('formImport');
                            if (frm) frm.submit();
                        }
                    }
                });
            }

            initFilterOptions();
        })();
    </script>
}
